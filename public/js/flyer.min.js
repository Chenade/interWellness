$(document).ready(function () {

    var data = [0,0,0];
    var refreshChart = function(){
        $.ajax({
            url: '/api/flyer/chart',
            method: 'GET',
            dataType: 'json',
    
            success: function (res) {
                var list = Object.entries(res.data);
                
                for(const i in list)
                {
                    const j = parseInt(list[i][0]) - 1;
                    data[j] = list[i][1];
                }
                drawPie();
            }
        });
    }, drawPie = function()
    {
        $('#chartBox').empty();
        $('#chartBox').html('<canvas id="chartPie" width="200" height="200"></canvas>');
        const ctx = document.getElementById('chartPie').getContext('2d');

        const config = {
            labels: [
            '傳單 - 全資訊',
            '傳單 - 營養資訊',
            '傳單 - 優惠資訊',
            'IG 貼文',
            'Facebook 按紐',
            ],
            datasets: [{
            label: 'Flyer Test',
            data: data,
            backgroundColor: [
                'rgb(195, 99, 60)',
                'rgb(244, 188, 29)',
                'rgb(56, 142, 144)',
                'rgb(233, 3, 214)',
                'rgb(57, 85, 144)'
            ],
            hoverOffset: 4
            }]
        };
        
        const chartPie = new Chart(ctx, {
            type: 'pie',
            data: config,
            options: {
            }
        });

        // ctx.canvas.parentNode.style.height = '128px';
    }, refreshTable = function(){
        var table = $('#flyerTable').DataTable({
            ajax: '/api/flyer/list',
            searching: false,
            columns: [
                { data: 'id' },
                { data: 'fid' },
                { data: 'created_at' },
            ],
            "drawCallback": function (settings) {
                // $( ".date-convert" ).each(function( index ) {
                //     var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
                //     $( this ).text(_tmp);
                //   });
                $('#updated_time').text(moment().format(' h:mm a, MMMM Do YYYY'));
            },
        });
    }, refreshPage = function(){
        refreshChart();
        refreshTable();
    };

    refreshPage();
});