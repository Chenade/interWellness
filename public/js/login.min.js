$(document).ready(function () {
    var id = "", isfaEnable = $('#is2fa').data('enable'), isrecaptcha = $('#isRecaptcha').data('enable');
    var login = function () {
        window.localStorage['uuid'] || guid();
        var btn = $('#login');
        btn.button('loading');
        var data = {
            'userID': $('#user').val(),
            'deviceID': window.localStorage['uuid'],
            'password': $('#password').val(),
            'language': $('#language').val(),
        };

        ajax('PUT', '/agent/login', data_format('/api/login', 0, 'POST', data), function (a) {
            btn.button('reset');
            if(!a.error){
                document.cookie = "Authorization="+a.Authorization;
                id = a.id;
                if(a['2fa'] && isfaEnable){
                    $('.smsCode').val("");
                    $('#SMS-modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }else
                    loginSave();
            }else
                $.growl.error({message: a.error})
        });
    }, passwordChangedRequired = function(){
        $.growl.warning({message: langDict['passwordnotchange3month']});
        $('#newPassword-modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    }, userLog = function () {
        var obj = {'startTime': new moment(new Date()).subtract(7, 'days'), 'stopTime': new moment(new Date()), 'count': 10, 'level': ["3", "2", "1", "0"]}
        ajax('PUT', '/agent/api', data_format('/api/user/log/search', 0, 'POST', obj, null), function (a) {
            if(!a.error){
                var err = [];
                for(const i in a){
                    var content = (a[i].content) ? a[i].content.split(":")[1] : "";
                    err.push(content.trim() + "@" + a[i].timestamp);
                }
                localStorage.setItem('errorLog', err);
                window.location.href = '/';
            }else
                $.growl.warning({message: a.error});
        });
    }, loginSave = function () {
        ajax('PUT', '/agent/api', data_format('/api/user?uid=' + id, 0, 'GET', {}, null), function (user) {
            var last = new moment(user.passwordSetDate), today = new moment(new Date());
            var duration = moment.duration(today.diff(last)).asMonths();
            ajax('PUT', '/agent/loginSave', data_format('loginSave', 0, 'POST', {'verify': true}, null), function (e) {
                if(duration >= 3) passwordChangedRequired();
                else userLog();
            });
        });
    };

    $('#language').val($('[name="_lang"]').attr('content')).selectpicker('refresh');
    $('#login').on('click', function () {
        if(isrecaptcha){
            var token = grecaptcha.getResponse();
            $.getJSON("https://api.ipify.org/?format=json", function(e) {
                ajax('PUT', '/agent/recaptcha', data_format('/api/recaptcha', 0, 'POST', {'response': token, 'remoteIp' : e.ip}, null), function (a) {
                    grecaptcha.reset();
                    if(!a.error){
                        if(a.success)
                            login();
                        else
                            $.growl.error({message: langDict['msgValidationError']});
                    }else
                        $.growl.error({message: a.error});
                });
            });
        }else
            login();
    });

    $("#password").keypress(function( event ) {
        if(event.key === "Enter") $('#login').click();
    });
    $('#language').on("change", function () {
        window.location.href = '/language/' + $(this).val();
    });

    var tryCount = 0;
    $('.smsCode').on('keyup keydown click', function (e) {
        switch (e.type) {
            case "keyup":
                var key = e.which,
                    t = $(e.target),
                    sib = t.closest('div').next().find('.smsCode');

                if (key !== 9 && key !== 13 && (key < 48 || key > 57) && (key < 96 || key > 105)) {
                    $.growl.notice({message: langDict['numberOnly']})
                    e.preventDefault();
                    return false;
                }
                if (key === 9) return true; // Tab
                if (!sib || !sib.length) sib = $('.smsCode').eq(0);
                sib.select().focus();
                break;
            case "keydown":
                var key = e.which;
                if (key === 13) $('#SMS_confirm').click();
                if (key === 9 || (key >= 48 && key <= 57) || (key >= 96 && key <= 105)) {
                    return true;
                }
                e.preventDefault();
                return false;
                break;
            case "click":
                $(e.target).select();
                break;
        }
    });
    $('#SMS_confirm').on('click', function () {
        var sms = "";
        tryCount += 1;
        $('.smsCode').each(function(i,element){
            sms += $(element).val();
        })
        ajax('PUT', '/agent/api', data_format('/api/user/2fa/verify', 0, 'POST', {'code': sms}, null), function (a) {
            if(!a.error) {
                $('#qrcode-modal').modal('hide');
                loginSave();
            }
            else{
                $('.smsCode').eq(0).select().focus();
                $('.smsCode').val("");
                $.growl.error({message: a.error});
                if(tryCount == 3){
                    $.growl.error({message: langDict['ValidationError3Times']});
                    setTimeout(function () {
                        window.location.href = '/logout';
                    }, 1000);
                }

            }
        });
    });
    $('#SMS-modal').on('hidden.bs.modal', function (e) {
        window.location.href = '/logout';
    });

    $('#newPassword-modal').on('hidden.bs.modal', function (e) {
        userLog();
    });
});